

/************************************************************************************************/
## 轨迹跟踪 (可信度2/5) 
/************************************************************************************************/

在轨迹跟踪中，小车的坐标偏离轨迹是不可避免的，而为了度量这种偏离并进行控制，通常采用**横向偏差**（lateral deviation）、**航向误差**（heading error）、以及其他误差量来评估当前状态与目标轨迹的差异。具体来说，这些步骤可以帮助控制偏离：

### 1. **误差度量**
在任意时刻，可以通过以下几个步骤来度量小车的偏离：

#### 1.1. 横向误差（Lateral Error）
- **定义**：小车当前位置到轨迹上最近点的垂直距离。
- **计算方法**：确定小车当前位置 \( P(x, y) \) 到轨迹上最近点 \( P_{track}(x_{track}, y_{track}) \) 的距离。这个误差可以通过投影的方法或几何方法来确定。

  \[
  e_{\text{lat}} = \sqrt{(x - x_{\text{track}})^2 + (y - y_{\text{track}})^2}
  \]

  其中 \( x, y \) 为小车当前坐标，\( x_{\text{track}}, y_{\text{track}} \) 为轨迹上对应最近点的坐标。

#### 1.2. 航向误差（Heading Error）
- **定义**：小车当前行驶方向与轨迹上最近点的切线方向的角度差。
- **计算方法**：假设小车的当前朝向为 \( \theta \)，轨迹在当前最近点的切线方向为 \( \theta_{\text{track}} \)，则航向误差 \( e_{\text{heading}} \) 为两者的差值。

  \[
  e_{\text{heading}} = \theta - \theta_{\text{track}}
  \]

  其中 \( \theta \) 是小车的朝向角（一般是相对于某参考轴，如世界坐标系的X轴），而 \( \theta_{\text{track}} \) 是轨迹上最近点的切线方向。

### 2. **控制方法**
根据上述误差，可以采用以下几种控制策略，确保偏离不会扩大，并将小车引回到规划轨迹上：

#### 2.1. PID 控制器
对于横向误差和航向误差，可以使用**PID控制器**（比例-积分-微分控制器）来对转向角进行调整：

- **输入**：横向误差 \( e_{\text{lat}} \) 和航向误差 \( e_{\text{heading}} \)。
- **输出**：方向盘的转向角 \( \delta \)。

控制律可以为：

\[
\delta = K_p \cdot e_{\text{lat}} + K_d \cdot \frac{de_{\text{lat}}}{dt} + K_{\theta} \cdot e_{\text{heading}}
\]

其中 \( K_p \)、\( K_d \)、\( K_{\theta} \) 是控制增益，调整这些参数可以平衡响应速度和稳定性。

#### 2.2. 纯追踪控制（Pure Pursuit）
纯追踪法是一种基于几何的控制方法，通过不断调整小车的方向，使小车朝向某一段时间后的目标点，逐渐将其引回轨迹。

- **选择目标点**：在轨迹上选择一个距离小车一定距离 \( L \) 的目标点。
- **转向角计算**：转向角 \( \delta \) 由目标点与当前车身位置的角度差决定：

  \[
  \delta = \arctan\left(\frac{2L \sin \alpha}{L_f}\right)
  \]

  其中 \( \alpha \) 是车头指向与目标点连线的角度差，\( L_f \) 是车辆轴距。

通过这个控制器，小车总是朝向某个预测目标点，因此能够跟随曲线路径。

#### 2.3. Stanley 控制器
Stanley 控制器能够同时考虑横向误差和航向误差，并使用非线性控制律将小车保持在轨迹上。其控制律为：

\[
\delta = \theta_{\text{track}} - \theta + \arctan\left(\frac{K \cdot e_{\text{lat}}}{v}\right)
\]

其中，\( \theta_{\text{track}} \) 是轨迹方向，\( \theta \) 是小车当前方向，\( e_{\text{lat}} \) 是横向误差，\( v \) 是小车速度，\( K \) 是控制增益。

#### 2.4. 模型预测控制（MPC）
**MPC**是一种更复杂的控制算法，它不仅考虑当前时刻的误差，还能预测未来一段时间内小车的轨迹，进行优化控制。MPC的主要步骤如下：
- 根据当前小车状态，预测未来多步的状态（位置、速度、方向等）。
- 使用优化算法最小化预测误差，得到一组控制命令（如转向角和速度）。
- 执行优化后的控制命令，使小车更精确地跟随轨迹。

MPC的优势在于可以同时处理多个约束（如速度限制、转向角限制）以及复杂的非线性车辆模型。

### 3. **实际应用中的调优**
- **控制器参数调优**：需要根据实际场景和车辆的动力学特性调整控制器的参数（如PID控制器的增益、Stanley控制器的增益等），以在不同曲率和速度下获得良好的跟踪性能。
- **误差限界**：为确保误差不会放大，可以设置一个误差阈值，当横向或航向误差超过该阈值时，可以减速或采取更激进的控制措施来纠正偏差。

通过这些方法，可以有效控制小车偏离规划轨迹的程度，确保其准确跟踪预定路径，即使在复杂的曲线路段。






